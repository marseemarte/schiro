<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Respuesta - GATTO</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/respuestas.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Chewy&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/respuesta.css">
</head>
<body>
  <header class="site-header">
    <div class="brand">GATTO</div>
    <nav class="main-nav">
      <a href="/" class="nav-chip chip-blue">Nueva b√∫squeda</a>
    </nav>
    <a href="#" class="btn-top">Trabajemos juntos</a>
  </header>

  <main>
    <section class="hero">
      <div class="hero-left">
        <img src="{{ url_for('static', filename='img/gatito.png') }}" alt="Gatito" class="cat-hero">
      </div>
      <div class="hero-right">
        <h1>¬°Esto es lo que encontr√©!</h1>
        <form class="search-form" action="/buscar" method="POST">
          <div class="search">
            <span class="search-icon">üîé</span>
            <input id="searchBox" name="duda" type="text" placeholder="Escrib√≠ otra duda" value="{{ duda }}" required>
          </div>
        </form>
      </div>
    </section>

    <section class="board respuesta-board">
      <div class="board-inner">
        <div class="answer-content">
          <h3>Respuesta del profesor</h3>
          <article class="answer">
            <div id="answerRaw" class="answer-raw">{{ respuesta }}</div>
            
            <div class="slider" aria-live="polite">
              <button id="prevBtn" class="slider-btn" aria-label="Anterior" title="Anterior">‚óÄ</button>
              
              <div>
                <div class="slide-header">
                  <h3 class="slide-title" id="slideTitle"></h3>
                </div>
                <div id="slideContent" class="slide-content" role="region" aria-live="polite"></div>
                <div class="slide-indicator" id="slideIndicator">0 / 0</div>
              </div>
              
              <button id="nextBtn" class="slider-btn" aria-label="Siguiente" title="Siguiente">‚ñ∂</button>
            </div>
          </article>
        </div>
      </div>
    </section>
  </main>

  <script src="{{ url_for('static', filename='js/index.js') }}"></script>

  <script>
    // Procesa la respuesta generada por la IA y la divide en 4 secciones:
    // 1) Explicaci√≥n m√°s t√©cnica
    // 2) Explicaci√≥n simple
    // 3) Ejemplos cotidianos din√°micos
    // 4) Desaf√≠o para practicar
    (function () {
      const rawEl = document.getElementById('answerRaw');
      const contentEl = document.getElementById('slideContent');
      const indicatorEl = document.getElementById('slideIndicator');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const titleEl = document.getElementById('slideTitle');

      if (!rawEl) return;

      // Tomamos el texto (sin HTML) para trabajar m√°s robustamente
      let rawText = rawEl.textContent || rawEl.innerText || '';
      rawText = rawText.replace(/\r/g, ''); // normalizar saltos

      // Intentamos dividir buscando "1)", "2)", "3)", "4)" (con lookahead)
      let parts = rawText.split(/(?=\b[1-4]\)\s)/g).map(s => s.trim()).filter(Boolean);

      // Si el modelo no devolvi√≥ los marcadores, tratamos de dividir por t√≠tulos comunes
      if (parts.length < 4) {
        // buscamos encabezados numerados con par√©ntesis o nombre de secci√≥n
        parts = rawText.split(/(?=\n*(?:1\)|1\.|Explicaci[o√≥]n m√°s t√©cnica|Explicaci√≥n m√°s t√©cnica))/i).map(s => s.trim()).filter(Boolean);
      }

      // Si a√∫n no llegamos a 4, hacemos un fallback: dividir en 4 partes iguales
      if (parts.length < 4) {
        const lines = rawText.split('\n');
        const chunkSize = Math.ceil(lines.length / 4) || 1;
        parts = [];
        for (let i = 0; i < 4; i++) {
          const chunk = lines.slice(i * chunkSize, (i + 1) * chunkSize).join('\n').trim();
          parts.push(chunk || '');
        }
      }

      // Normalizamos: removemos el prefijo "1) " etc. en cada parte para una visual m√°s limpia
      parts = parts.map(p => p.replace(/^\d\)\s*/,'').trim());

      let idx = 0;
      const total = parts.length;

      function render() {
        let content = parts[idx] || '';
        
        // Aplicar formato al contenido
        content = content
          // Convertir asteriscos en negritas HTML
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<strong>$1</strong>')
          
          // Formatear listas manteniendo los guiones
          .replace(/[-‚Ä¢]\s+(.*)/g, '<div class="list-item">$1</div>')
          
          // Agregar emojis contextuales
          .replace(/\b(n√∫mero|suma|resta|multiplicaci√≥n|divisi√≥n)\b/gi, 'üî¢ $1')
          .replace(/\b(planeta|tierra|sol|luna)\b/gi, 'üåç $1')
          .replace(/\b(animal|animales)\b/gi, 'üêæ $1')
          .replace(/\b(planta|plantas|√°rbol|√°rboles)\b/gi, 'üå± $1');

        contentEl.innerHTML = content;
        contentEl.setAttribute('data-slide', idx + 1);
        indicatorEl.innerHTML = `
          <span style="color: #FFB648">Paso ${idx + 1}</span> de ${total}
          ${getSlideEmoji(idx)}
        `;
        titleEl.innerHTML = `Parte ${idx + 1}: ${getSlideTitle(idx)}`;
        
        prevBtn.disabled = idx === 0;
        nextBtn.disabled = idx === total - 1;
      }

      function getSlideEmoji(index) {
        const emojis = ['üìö', 'üí°', 'üåü', 'üéÆ'];
        return emojis[index] || '';
      }

      function getSlideTitle(index) {
        const titles = [
          'Introducci√≥n',
          'Respuesta para la carpeta',
          'Explicaci√≥n simple',
          'Ejemplos cotidianos',
          'Desaf√≠o para practicar'
        ];
        return titles[index] || '';
      }

      prevBtn.addEventListener('click', () => {
        if (idx > 0) { idx--; render(); }
      });
      nextBtn.addEventListener('click', () => {
        if (idx < total - 1) { idx++; render(); }
      });

      // Soporte flechas del teclado
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { if (idx > 0) { idx--; render(); } }
        if (e.key === 'ArrowRight') { if (idx < total - 1) { idx++; render(); } }
      });

      // Inicializamos
      render();
    })();
  </script>
</body>
</html>
