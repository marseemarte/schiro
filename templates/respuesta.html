<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Respuesta - GATTO</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/respuestas.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Chewy&family=Nunito:wght@400;700;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="css/respuesta.css">
</head>

<body>
  <header class="site-header">
    <div class="brand">GATTO</div>
    <nav class="main-nav">
      <a href="/" class="nav-chip chip-blue">Nueva bÃºsqueda</a>
    </nav>
    <a href="#" class="btn-top">Trabajemos juntos</a>
  </header>

  <main>
    <section class="hero">
      <div class="hero-left">
        <img src="{{ url_for('static', filename='img/gatito.png') }}" alt="Gatito" class="cat-hero">
      </div>
      <div class="hero-right">
        <h1>Â¡Esto es lo que encontrÃ©!</h1>
        <form class="search-form" action="/buscar" method="POST">
          <div class="search">
            <span class="search-icon">ğŸ”</span>
            <input id="searchBox" name="duda" type="text" placeholder="EscribÃ­ otra duda" value="{{ duda }}" required>
          </div>
        </form>
      </div>
    </section>

    <section class="board respuesta-board">
      <div class="board-inner">
        <div class="answer-content">
          <h3>Respuesta del profesor ğŸˆ</h3>
          <p>ğŸ¤”Tu pregunta: {{ duda }}</p>
          <div style="display: flex; justify-content: space-between; ">
            <article class="answer">
              <div id="answerRaw" class="answer-raw">{{ respuesta }}</div>

              <div class="slider" aria-live="polite">
                <button id="prevBtn" class="slider-btn" aria-label="Anterior" title="Anterior">â—€</button>

                <div>
                  <div class="slide-header">
                    <h3 class="slide-title" id="slideTitle"></h3>
                  </div>
                  <div id="slideContent" class="slide-content" role="region" aria-live="polite"></div>
                  <div class="slide-indicator" id="slideIndicator">0 / 0</div>
                </div>

                <button id="nextBtn" class="slider-btn" aria-label="Siguiente" title="Siguiente">â–¶</button>
              </div>
            </article>

            <article>
              <img src="{{ url_for('static', filename='img/respuesta_tÃ©cnica.png') }}" class="mb-20"
                class="cat-answer"
                alt="Respuesta tÃ©cnica">
            </article>
          </div>

        </div>
      </div>
    </section>
  </main>

  <script src="{{ url_for('static', filename='js/index.js') }}"></script>

  <script>
    // Procesa la respuesta generada por la IA y la divide en 4 secciones:
    // 1) ExplicaciÃ³n mÃ¡s tÃ©cnica
    // 2) ExplicaciÃ³n simple
    // 3) Ejemplos cotidianos dinÃ¡micos
    // 4) DesafÃ­o para practicar
    (function () {
      const rawEl = document.getElementById('answerRaw');
      const contentEl = document.getElementById('slideContent');
      const indicatorEl = document.getElementById('slideIndicator');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const titleEl = document.getElementById('slideTitle');

      if (!rawEl) return;

      // Tomamos el texto (sin HTML) para trabajar mÃ¡s robustamente
      let rawText = rawEl.textContent || rawEl.innerText || '';
      rawText = rawText.replace(/\r/g, ''); // normalizar saltos

      // Intentamos dividir buscando "1)", "2)", "3)", "4)" (con lookahead)
      let parts = rawText.split(/(?=\b[1-4]\)\s)/g).map(s => s.trim()).filter(Boolean);

      // Si el modelo no devolviÃ³ los marcadores, tratamos de dividir por tÃ­tulos comunes
      if (parts.length < 4) {
        // buscamos encabezados numerados con parÃ©ntesis o nombre de secciÃ³n
        parts = rawText.split(/(?=\n*(?:1\)|1\.|Explicaci[oÃ³]n mÃ¡s tÃ©cnica|ExplicaciÃ³n mÃ¡s tÃ©cnica))/i).map(s => s.trim()).filter(Boolean);
      }

      // Si aÃºn no llegamos a 4, hacemos un fallback: dividir en 4 partes iguales
      if (parts.length < 4) {
        const lines = rawText.split('\n');
        const chunkSize = Math.ceil(lines.length / 4) || 1;
        parts = [];
        for (let i = 0; i < 4; i++) {
          const chunk = lines.slice(i * chunkSize, (i + 1) * chunkSize).join('\n').trim();
          parts.push(chunk || '');
        }
      }

      // Normalizamos: removemos el prefijo "1) " etc. en cada parte para una visual mÃ¡s limpia
      parts = parts.map(p => p.replace(/^\d\)\s*/, '').trim());

      let idx = 0;
      const total = parts.length;

      function render() {
        let content = parts[idx] || '';

        // Aplicar formato al contenido
        content = content
          // Convertir asteriscos en negritas HTML
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<strong>$1</strong>')

          // Formatear listas manteniendo los guiones
          .replace(/[-â€¢]\s+(.*)/g, '<div class="list-item">$1</div>')

          // Agregar emojis contextuales
          .replace(/\b(nÃºmero|suma|resta|multiplicaciÃ³n|divisiÃ³n)\b/gi, 'ğŸ”¢ $1')
          .replace(/\b(planeta|tierra|sol|luna)\b/gi, 'ğŸŒ $1')
          .replace(/\b(animal|animales)\b/gi, 'ğŸ¾ $1')
          .replace(/\b(planta|plantas|Ã¡rbol|Ã¡rboles)\b/gi, 'ğŸŒ± $1');

        contentEl.innerHTML = content;
        contentEl.setAttribute('data-slide', idx + 1);
        indicatorEl.innerHTML = `
          <span style="color: #FFB648">Paso ${idx + 1}</span> de ${total}
          ${getSlideEmoji(idx)}
        `;
        titleEl.innerHTML = `Parte ${idx + 1}: ${getSlideTitle(idx)}`;

        prevBtn.disabled = idx === 0;
        nextBtn.disabled = idx === total - 1;
      }

      function getSlideEmoji(index) {
        const emojis = ['ğŸ“š', 'ğŸ’¡', 'ğŸŒŸ', 'ğŸ®'];
        return emojis[index] || '';
      }

      function getSlideTitle(index) {
        const titles = [
          'IntroducciÃ³n',
          'Respuesta para la carpeta',
          'ExplicaciÃ³n simple',
          'Ejemplos cotidianos',
          'DesafÃ­o para practicar'
        ];
        return titles[index] || '';
      }

      prevBtn.addEventListener('click', () => {
        if (idx > 0) { idx--; render(); }
      });
      nextBtn.addEventListener('click', () => {
        if (idx < total - 1) { idx++; render(); }
      });

      // Soporte flechas del teclado
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { if (idx > 0) { idx--; render(); } }
        if (e.key === 'ArrowRight') { if (idx < total - 1) { idx++; render(); } }
      });

      // Inicializamos
      render();
    })();
  </script>
</body>

</html>